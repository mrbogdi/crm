<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PINventory</title>
  
  <!-- Fluent UI Web Components -->
  <script type="module" src="https://unpkg.com/@fluentui/web-components"></script>
  
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f3f3f3;
      margin: 0;
      padding: 2rem;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .product {
      border-bottom: 1px solid #ddd;
      padding: 1rem 0;
    }
    .actions {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

  <div class="container">
    <h2>üîê PINventory</h2>
    
    <!-- PIN Screen -->
    <div id="pinScreen">
      <p id="pinMessage">SeteazƒÉ un PIN pentru aplica»õie:</p>
      <fluent-text-field id="pinInput" type="password" placeholder="PIN (minim 4 cifre)"></fluent-text-field>
      <fluent-button appearance="accent" style="margin-top: 1rem;" onclick="handlePin()">ContinuƒÉ</fluent-button>
    </div>
    
    <!-- App Screen -->
    <div id="appScreen" class="hidden">
      <fluent-text-field id="name" placeholder="Nume produs"></fluent-text-field>
      <fluent-number-field id="qty" placeholder="Cantitate"></fluent-number-field>
      <fluent-number-field id="price" placeholder="Pre»õ (RON)"></fluent-number-field>
      <fluent-text-area id="note" placeholder="Note" style="margin-bottom: 1rem;"></fluent-text-area>
      <fluent-button appearance="accent" onclick="addProduct()">AdaugƒÉ produs</fluent-button>

      <hr style="margin: 2rem 0;" />

      <div id="productList"></div>
    </div>
  </div>

  <script>
    // --- Simple Crypto (AES)
    async function digestMessage(msg) {
      const encoder = new TextEncoder();
      const data = encoder.encode(msg);
      return window.crypto.subtle.digest('SHA-256', data);
    }

    async function deriveKey(pin) {
      const keyMaterial = await digestMessage(pin);
      return window.crypto.subtle.importKey(
        "raw", keyMaterial, { name: "AES-GCM" }, false, ["encrypt", "decrypt"]
      );
    }

    async function encryptData(text, pin) {
      const enc = new TextEncoder();
      const iv = window.crypto.getRandomValues(new Uint8Array(12));
      const key = await deriveKey(pin);
      const encoded = enc.encode(text);
      const cipher = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv }, key, encoded);
      return btoa(String.fromCharCode(...iv) + String.fromCharCode(...new Uint8Array(cipher)));
    }

    async function decryptData(base64, pin) {
      const bytes = atob(base64).split('').map(c => c.charCodeAt(0));
      const iv = new Uint8Array(bytes.slice(0, 12));
      const data = new Uint8Array(bytes.slice(12));
      const key = await deriveKey(pin);
      const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, data);
      return new TextDecoder().decode(decrypted);
    }

    // --- App Logic
    const pinScreen = document.getElementById("pinScreen");
    const appScreen = document.getElementById("appScreen");
    const pinInput = document.getElementById("pinInput");
    const pinMessage = document.getElementById("pinMessage");

    let appPIN = "";
    let products = [];

    async function handlePin() {
      const enteredPIN = pinInput.value.trim();
      if (enteredPIN.length < 4) return alert("PIN prea scurt!");

      const savedHash = localStorage.getItem("pin_hash");

      const hash = await digestMessage(enteredPIN);
      const hashStr = Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');

      if (!savedHash) {
        localStorage.setItem("pin_hash", hashStr);
        appPIN = enteredPIN;
        loadApp();
      } else if (hashStr === savedHash) {
        appPIN = enteredPIN;
        loadApp();
      } else {
        alert("PIN incorect!");
      }
    }

    async function loadApp() {
      pinScreen.classList.add("hidden");
      appScreen.classList.remove("hidden");
      const encrypted = localStorage.getItem("products");
      if (encrypted) {
        try {
          const data = await decryptData(encrypted, appPIN);
          products = JSON.parse(data);
        } catch (e) {
          alert("Eroare de criptare!");
        }
      }
      renderProducts();
    }

    async function saveProducts() {
      const data = JSON.stringify(products);
      const encrypted = await encryptData(data, appPIN);
      localStorage.setItem("products", encrypted);
    }

    function renderProducts() {
      const container = document.getElementById("productList");
      container.innerHTML = "";
      products.forEach((p, i) => {
        const div = document.createElement("div");
        div.className = "product";
        div.innerHTML = `
          <b>${p.name}</b> ‚Äî ${p.qty} buc x ${p.price} RON
          <br><i>${p.note || ""}</i>
          <div class="actions">
            <fluent-button appearance="outline" onclick="editProduct(${i})">EditeazƒÉ</fluent-button>
            <fluent-button appearance="stealth" onclick="deleteProduct(${i})">»òterge</fluent-button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function addProduct() {
      const name = document.getElementById("name").value;
      const qty = parseInt(document.getElementById("qty").value);
      const price = parseFloat(document.getElementById("price").value);
      const note = document.getElementById("note").value;

      if (!name || isNaN(qty) || isNaN(price)) return alert("CompleteazƒÉ toate c√¢mpurile!");

      products.push({ name, qty, price, note });
      await saveProducts();
      renderProducts();

      document.getElementById("name").value = "";
      document.getElementById("qty").value = "";
      document.getElementById("price").value = "";
      document.getElementById("note").value = "";
    }

    async function deleteProduct(i) {
      if (!confirm("»òtergi produsul?")) return;
      products.splice(i, 1);
      await saveProducts();
      renderProducts();
    }

    function editProduct(i) {
      const p = products[i];
      document.getElementById("name").value = p.name;
      document.getElementById("qty").value = p.qty;
      document.getElementById("price").value = p.price;
      document.getElementById("note").value = p.note;
      products.splice(i, 1);
    }
  </script>
</body>
</html>
